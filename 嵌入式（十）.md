<h1><center>嵌入式（十）</center></h1>

## 一、异常的响应过程

当一个异常出现以后，ARM微处理器会执行以下几步操作：

1. 将下一条指令的地址存入相应连接寄存器LR，以便在处理异常返回时能从正确的位置重新开始执行。若异常是从ARM状态进入，LR寄存器中保存的是下一条指令的地址（当前PC+4或PC+8，与异常的类型有关）；若异常是从Thumb状态进入，则在LR寄存器中保存当前PC的偏移量
2. 将CPSR状态传送到相应的SPSR中
3. 根据异常类型，强制设置CPSR的运行模式位
4. 强制PC从相关的异常向量地址取下一条指令执行，跳转到相应的异常处理程序，还可以设置中断禁止位，以禁止中断发生



如果异常发生时，处理器处于Thumb状态，则当异常向量地址加载入PC时，处理器自动切换到ARM状态。

异常处理完毕之后，ARM微处理器会执行以下几步操作从异常返回：

1. 将连接寄存器LR的值减去相应的偏移量后送到PC中
2. 将SPSR内容送到CPSR中
3. 若在进入异常处理时设置了中断禁止位，则在此清除

可以认为应用程序总是从复位异常处理程序开始执行的，因此复位异常处理程序不需要返回。



## 二、应用程序中的异常处理

1. 在应用程序的设计中，异常处理采用的方式是在异常向量表中的特定位置放置一条跳转指令，跳转到异常处理程序。
2. 当ARM处理器发生异常时，程序计数器PC会被强制设置为对应的异常向量，从而跳转到异常处理程序，当异常处理完成以后，返回到主程序继续执行



## 三、ARM系统的中断处理

#### （一）在ARM系统中，一旦有中断发生，正在执行的程序都会停下来，通常都会执行如下的中断步骤:

1. 保存现场。保存当前的PC值到R14,保存当前的程序运行状态到SPSR
2. 模式切换。根据发生的中断类型，进入IRQ模式或FIQ模式
3. 获取中断服务子程序地址。PC指针跳到异常向量表所保存的IRQ或FIQ地址处，IRQ或FIQ的异常向量地址处-般保存的是中断服务子程序的地址，PC指针跳入到中断服务子程序，进行中断处理
4. 多个中断请求处理。在ARM系统中，可以存在多个中断请求源，比如事口中断、AD中断、外部中断、定时器中断及DMA中断等，所以可能出现多个中断源同时请求中断的情况。为了更好地区分各个中断源，通常为这些中断定义不同的优先级别，并为每-个中断设置-个中断标志位。当发生中断时，通过判断中断优先级以及访问中断标志位的状态来识别哪一个中断发生了， 进而调用相应的函数进行中断处理
5. 中断返回，恢复现场。当完成中断服务子程序后，将SPSR中保存的程序运行状态恢复到CPSR中，R14 中保存的被中断程序的地址恢复到PC中，继续执行被中断的程序。



#### （二）S3C2410A的中断控制器

S3C2410A采用ARM920T CPU内核，ARM920T CPU的中断包含有IRQ和FIQ。IRQ 是普通中断，FIQ 是快速中断，FIQ 的优先级高于IRQ。FIQ中断通常在进行大批量的复制、数据传输等工作时使用。

S3C2410A通过对程序状态寄存器(PSR) 中的F位和I位进行设置控制CPU的中断响应。如果设置PSR的F位为1，则CPU不会响应来自中断控制器的FIQ中断:

如果设置PSR的I位为1，则CPU不会响应来自中断控制器的IRQ中断。如果设置PSR的F位或I位设置为0，同时将中断屏蔽奇存器(INTMSK)中的相对应位设置为0，CPU响应来白中断控制器的IRQ或FIQ中断请求。中断屏藏寄存器用于指示中断是否禁止。如果设置中断屏蔽寄存器中的相对应屏蔽位为1。表示相对应的中断禁止:如果设置为0，表示中新发生时将正常执行中断服务。如果发生中断时相对应的屏藏位正好为1，则中断挂起寄存器中的相对中断源井起位将置1。

S3C2410A有SRCPND (中断源挂起寄春器)和INTPND (中断井起寄春器)两个中断挂起吉存器。SRCPND和NTPND两个挂起吉存器用于指示某个中断请求是否处于挂起状态。当多个中国源请求中断服务时，SRCPND 青存器中的相应位设置为1，中裁过程结束后NTPND寄存器中只有1位被自动设置为1。

S3C2410A中的中断控制器能够接收来自56个中断源的请求，这些中断源来自DMA控制器、UART. PC及外部中断引脚等。S3C2410A共有32个中断请求信号。S3C2410A 采用了中断共享技术，INT UARTO、INT UARTI。INT UART2、EINT8 23和FINT47为多个中断源共中使用的中断请求信号。中断请求的优先级逻辑是由7个仲盐器组成的。其中包括6个一级仲藏器和1个二级件故器。每个仲裁器是否使能由寄存器PRIORITY[6:0]决定。每个种哉器可以处理4~ 6个中断源，从中过出优先级最高的。优先级顺序由寄存器PRIORITY[20:7] 的相应位决定。S3C2410A 中断控制器的特殊寄存器如表所示，中断控制需要正确的设置这些寄存器。